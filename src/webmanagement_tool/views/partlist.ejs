<html lang="en">

<head>

    <link href="./bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
    <link href="./bower_components/awesomplete/awesomplete.css" rel="stylesheet">
    <link href="./bower_components/font-awesome/web-fonts-with-css/css/fontawesome.min.css" rel="stylesheet">





    <link href="/css/cards.css" rel="stylesheet">
    <link href="./main.css" rel="stylesheet">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="kaps avatar test side">
    <meta name="author" content="Marcel Ochsendorf">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title>PROJECT BOX MANAGER - PARTS</title>



    <style>
        #myInput {
            background-image: url('/img/np_search_1355726_000000.png');
            /* Add a search icon to input */
            background-position: 10px 12px;
            /* Position the search icon */
            background-repeat: no-repeat;
            /* Do not repeat the icon image */
            width: 100%;
            /* Full-width */
            font-size: 16px;
            /* Increase font-size */
            padding: 12px 20px 12px 60px;
            /* Add some padding */
            border: 1px solid #ddd;
            /* Add a grey border */
            margin-bottom: 12px;
            /* Add some space below the input */
        }
    </style>
</head>

<body class="container">

    <header>
        <% include ./partials/header %>
    </header>







    <div class="row my-12">
        <div class="col-lg-12" style="height:50px; width:100%; clear:both;">
            <input type="text" id="searchInput" onkeyup="filter_function()" placeholder="search for Parts">
        </div>
    </div>



    <div class="row" id="part_cards_holder">
    </div>




    <script src="./bower_components/jquery/dist/jquery.js"></script>
    <script src="./bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type='text/javascript' src='./bower_components/chart.js/dist/Chart.bundle.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
    <script type='text/javascript' src='./bower_components/awesomplete/awesomplete.min.js'></script>




    <script>
        var socket = null;

        var projects_list_str = <%- parts %>;

        var card_html_template_str = "";
        var card_new_project_str = "";


        var hide_closed_projects = true;

        function timeConverter(UNIX_timestamp, with_time = false) {
            try {
                var a = new Date(UNIX_timestamp * 1000);
                var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                var year = a.getFullYear();
                var month = months[a.getMonth()];
                var date = a.getDate();
                var hour = a.getHours();
                var min = a.getMinutes();
                var sec = a.getSeconds();
                if (with_time) {
                    return date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec;
                } else {
                    return date + ' ' + month + ' ' + year;
                }
            } catch (error) {
                return UNIX_timestamp
            }
        }




        function filter_function() {
            // Declare variables
            $("part_cards_holder").html("");
            var items = projects_list_str.parts;
            var items_filtered = [];
            var input = document.getElementById('searchInput');
            var filter = input.value.toLowerCase();


            // Loop through all list items, and hide those who don't match the search query
            for (i = 0; i < items.length; i++) {
                //SEARCH FOR TITLE
                if (!items[i].title) {
                    console.log("item:" + items[i]._id + " has no title attr");
                    
                }else{
                    if (items[i].title.toLowerCase().indexOf(filter) > -1) {
                        items_filtered.push(items[i]);
                        continue;
                    }
                }
               

                if (!items[i].keywords) {
                    console.log("item:" + items[i]._id + " has no keyword array");
                    continue;
                }
                for (j = 0; j < items[i].keywords.length; j++) {
                    if (items[i].keywords[j].toLowerCase().indexOf(filter) > -1) {
                        items_filtered.push(items[i]);
                        continue;
                    }
                }

            }


            parse_project_list_and_gen_tables(items_filtered);
        }




        function parse_project_list_and_gen_tables(_dt) {
            //TODO 
            $("part_cards_holder").html("");
            if (card_html_template_str == "") {
                console.log("card_tmp_not_loaded");
                return;
            }
            for (let index = 0; index < _dt.length; index++) {
                const element = _dt[index];


                var card_html = card_html_template_str;
                card_html = card_html.replace("__%%PART_TITLE%%__", element.title);
                card_html = card_html.replace("__%%PART_TITLE%%__", element.title);


                var ul_list_html = "";
                if(element.additional_attributes){
                    ul_list_html+= "<ul>";
                    for (let aaindex = 0; aaindex < element.additional_attributes.length; aaindex++) {
                        const aaelement = element.additional_attributes[aaindex];
                        if(aaelement.value == ""){
                            continue;
                        }
                        ul_list_html += " <li>"+ aaelement.key+":" +aaelement.value+"</li>";
                    }
                    ul_list_html += "</ul>";
                }
                
                    
                

                card_html = card_html.replace("__%%PART_DESC%%__", element.desc + "<br>" + ul_list_html);
                card_html = card_html.replace("__%%PART_LINK%%__", "/part?id=" + element.part_id);
                card_html = card_html.replace("__%%PROJECT_ID%%__", "" + element.project_id);

                if(element.image_url){
                    card_html = card_html.replace("__%%PART_ICON%%__", element.image_url);
                }else{
                    card_html = card_html.replace("__%%PART_ICON%%__", "/img/part_default.png");
                }
                
                $("#part_cards_holder").append(card_html);




            }






        }





        $(document).ready(function () {







            console.log("ready!");

            $
            $.get("/card_template_parts.html", function (data) {
                card_html_template_str = data;

                var objectConstructor = {}.constructor;
                if (projects_list_str.constructor === objectConstructor) {
                    project_list = projects_list_str;
                } else {
                    try {
                        project_list = JSON.parse(projects_list_str);
                    } catch (err) { }
                }

                    parse_project_list_and_gen_tables(project_list.parts);






            });

           


            socket = io();
              socket.on('parts_update', function (data) {
              var objectConstructor = {}.constructor;
              if (projects_list_str.constructor === objectConstructor) {
                  projects_list = data;
                  } else {
                      try {
                          projects_list = JSON.parse(data);
                      } catch (err) {
            
                      }
                  }
                  parse_project_list_and_gen_tables(projects_list.parts);
              });
        });
    </script>

</body>

</html>